datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "go run github.com/steebchen/prisma-client-go"
  output   = "../internal/db"
}

// ============================================
// User & Authentication
// ============================================

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  name      String
  avatar    String?
  status    UserStatus @default(OFFLINE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  workspaces       WorkspaceMember[]
  ownedWorkspaces  Workspace[]       @relation("WorkspaceOwner")
  projectMembers   ProjectMember[]
  assignedTasks    Task[]            @relation("TaskAssignee")
  reportedTasks    Task[]            @relation("TaskReporter")
  comments         Comment[]
  notifications    Notification[]
  refreshTokens    RefreshToken[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY
}

// ============================================
// Workspace
// ============================================

model Workspace {
  id          String   @id @default(uuid())
  name        String
  description String?
  icon        String?
  color       String?
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner   User              @relation("WorkspaceOwner", fields: [ownerId], references: [id])
  members WorkspaceMember[]
  spaces  Space[]

  @@map("workspaces")
}

model WorkspaceMember {
  id          String     @id @default(uuid())
  workspaceId String
  userId      String
  role        MemberRole @default(MEMBER)
  joinedAt    DateTime   @default(now())

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@map("workspace_members")
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// Space & Project
// ============================================

model Space {
  id          String   @id @default(uuid())
  name        String
  description String?
  icon        String?
  color       String?
  workspaceId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projects  Project[]

  @@map("spaces")
}

model Project {
  id          String   @id @default(uuid())
  name        String
  key         String
  description String?
  icon        String?
  color       String?
  spaceId     String
  leadId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  space   Space           @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  members ProjectMember[]
  sprints Sprint[]
  tasks   Task[]
  labels  Label[]

  @@unique([spaceId, key])
  @@map("projects")
}

model ProjectMember {
  id        String            @id @default(uuid())
  projectId String
  userId    String
  role      ProjectMemberRole @default(MEMBER)
  joinedAt  DateTime          @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

enum ProjectMemberRole {
  LEAD
  MEMBER
  VIEWER
}

// ============================================
// Sprint
// ============================================

model Sprint {
  id        String       @id @default(uuid())
  name      String
  goal      String?
  projectId String
  status    SprintStatus @default(PLANNING)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   Task[]

  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

// ============================================
// Task
// ============================================

model Task {
  id          String       @id @default(uuid())
  key         String
  title       String
  description String?
  status      TaskStatus   @default(BACKLOG)
  priority    Priority     @default(MEDIUM)
  type        TaskType     @default(TASK)
  projectId   String
  sprintId    String?
  assigneeId  String?
  reporterId  String
  parentId    String?
  storyPoints Int?
  dueDate     DateTime?
  orderIndex  Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint      Sprint?      @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  reporter    User         @relation("TaskReporter", fields: [reporterId], references: [id])
  parent      Task?        @relation("SubTasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks    Task[]       @relation("SubTasks")
  labels      TaskLabel[]
  comments    Comment[]
  attachments Attachment[]

  @@unique([projectId, key])
  @@map("tasks")
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum Priority {
  LOWEST
  LOW
  MEDIUM
  HIGH
  HIGHEST
}

enum TaskType {
  EPIC
  STORY
  TASK
  BUG
  SUBTASK
}

// ============================================
// Labels
// ============================================

model Label {
  id        String   @id @default(uuid())
  name      String
  color     String
  projectId String
  createdAt DateTime @default(now())

  // Relations
  project Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks   TaskLabel[]

  @@unique([projectId, name])
  @@map("labels")
}

model TaskLabel {
  taskId  String
  labelId String

  // Relations
  task  Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label Label @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@id([taskId, labelId])
  @@map("task_labels")
}

// ============================================
// Comments & Attachments
// ============================================

model Comment {
  id        String   @id @default(uuid())
  content   String
  taskId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@map("comments")
}

model Attachment {
  id        String   @id @default(uuid())
  filename  String
  url       String
  mimeType  String
  size      Int
  taskId    String
  createdAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("attachments")
}

// ============================================
// Notifications
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  data      Json?
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMMENTED
  SPRINT_STARTED
  SPRINT_COMPLETED
  MENTION
  DUE_DATE_REMINDER
  PROJECT_INVITATION
  WORKSPACE_INVITATION
}
